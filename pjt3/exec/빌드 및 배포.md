# ë¹Œë“œ ë° ë°°í¬

# â˜ï¸ AWS EC2

## ğŸ³ Docker

## ğŸ”„ Jenkins (CI/CD ì„¤ì •)

### 1. Jenkins ì„¤ì¹˜

- ë²„ì „ : Jenkins 2.387.1
- jenkins ì´ë¯¸ì§€ ë‹¤ìš´
    
    `$ docker pull jenkins/jenkins:lts`â€™
    
- jenkins ì»¨í…Œì´ë„ˆ ë“±ë¡ í›„ ì‹¤í–‰
    
    `$ docker run -d -p 9090:8080 -v /jenkins:/var/jenkins_home --name jenkins -u root jenkins/jenkins:lts`
    

> íŠ¸ëŸ¬ë¸” : ìœ„ ë°©ì‹ëŒ€ë¡œ Jenkins ì»¨í…Œì´ë„ˆë¥¼ ë“±ë¡í•˜ë©´ Jenkinsë‚´ì—ì„œ í”ŒëŸ¬ê·¸ì¸ì´ ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ê°€ ë˜ì§€ ì•ŠìŒ, ìˆ˜ë™ìœ¼ë¡œ ì„¤ì¹˜í•´ë„ gitlabê³¼ ì—°ê²°í•˜ëŠ”ë° ë‹¤ì–‘í•œ ì˜¤ë¥˜ê°€ ë°œìƒí•¨.
> 
> 
> í•´ê²° :  docker-compose ë¥¼ ì´ìš©í•´ì„œ jenkinsë¥¼ ì„¤ì¹˜í•˜ë©´ ë¬¸ì œì—†ì´ ì§„í–‰ë¨.
> 
> - **docker-compose ì´ìš© ì  í‚¨ìŠ¤ ì»¨í…Œì´ë„ˆ ìƒì„±**
>     
>     ```bash
>     $ vim docker-compose.yml
>     
>     # docker-compose.yml
>     version: '3'
>     
>     services:
>         jenkins:
>             image: jenkins/jenkins:lts
>             container_name: jenkins
>             volumes:
>     	    - /usr/bin/docker:/usr/bin/docker
>                 - /var/run/docker.sock:/var/run/docker.sock
>                 - /jenkins:/var/jenkins_home
>             ports:
>                 - "9090:8080"
>             privileged: true
>             user: root
>     
>     # ì»¨í…Œì´ë„ˆ ìƒì„±
>     $ sudo docker-compose up -d
>     ```
>     

### 2. Jenkins ì ‘ì†

- url: "í¼ë¸”ë¦­ IPv4 ì£¼ì†Œ:9090" ìœ¼ë¡œ ì ‘ì†
- íŒ¨ìŠ¤ì›Œë“œ ì°¾ê¸°
    
    `$ docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword`
    
- ì ‘ì† í›„ gitlab, docker, ssh ê´€ë ¨ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜

### 3. **ì  í‚¨ìŠ¤ í”„ë¡œì íŠ¸ ìƒì„±**

- Freestyle Project ìƒì„±
- ì†ŒìŠ¤ì½”ë“œ ê´€ë¦¬ -  Git
    - Repository URL ì‘ì„±
    - credentials ìƒì„±
        
        ```bash
        Username : ì‹¸í”¼ê¹ƒ ì•„ì´ë””
        Password : ì‹¸í”¼ê¹ƒ ë¹„ë°€ë²ˆí˜¸
        ID : ì•„ë¬´ê±°ë‚˜ ë§ˆìŒëŒ€ë¡œ
        ```
        
- ë¹Œë“œ ìœ ë°œ ì„¤ì •
- secret token  ìƒì„±

### 4. ê¹ƒë© ì›¹í›… ì—°ê²°

- settings - webhook
- jenkins project URL, secret token ì…ë ¥
- Trigger ì„¤ì •

### 5. Dockerfile ì‘ì„±

```bash
# React Frontend Dockerfile

FROM node:16 as build-stage
WORKDIR /var/jenkins_home/workspace/gitlab/frontend
COPY package*.json ./
# ARG DISABLE_CACHE
RUN npm install
COPY . .
RUN npm run build

FROM nginx:stable-alpine as production-stage
COPY --from=build-stage /var/jenkins_home/workspace/gitlab/frontend/build /usr/share/nginx/html
COPY --from=build-stage /var/jenkins_home/workspace/gitlab/frontend/deploy_conf/nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 3000
# EXPOSE 443
CMD ["nginx", "-g", "daemon off;"]
```

```bash
# Spring Backend Dockerfile

FROM openjdk:11-jdk AS builder
COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src
RUN chmod +x ./gradlew
RUN ./gradlew bootJAR

FROM openjdk:11-jdk
COPY --from=builder build/libs/*.jar app.jar

# crawlingì„ ìœ„í•œ google-chrome, chromedriver ì„¤ì¹˜
RUN apt-get update
RUN wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
RUN apt -y install ./google-chrome-stable_current_amd64.deb
RUN wget https://chromedriver.storage.googleapis.com/112.0.5615.28/chromedriver_linux64.zip
RUN unzip chromedriver_linux64.zip
RUN mv chromedriver /usr/local/bin

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

```bash
# Kafka Dockerfile

FROM openjdk:11-jdk AS builder
COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src
RUN chmod +x ./gradlew
RUN ./gradlew bootJAR

FROM openjdk:11-jdk
COPY --from=builder build/libs/*.jar app.jar
EXPOSE 8090
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

### 6. ìë™ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸

- í•´ë‹¹ ë‹¨ê³„ë¥¼ ì§„í–‰í•˜ê¸° ì „ì— ê° í´ë”ì— Dockerfileì´ ì‘ì„±ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤.
- jenkins í”„ë¡œì íŠ¸ ì„¤ì • - Build Steps - Execute shell ì„ íƒ => ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬, ë¶™ì—¬ë„£ê¸°
    
    ```bash
    # backend
    docker build -t backimg ./backend
    if (docker ps | grep "backimg"); then docker stop backimg; fi
    docker run -it -d --rm -p 8080:8080 --name backimg backimg
    echo "Run spring"
    
    # frontend
    docker build -t frontimg ./frontend
    if (docker ps | grep "frontimg"); then docker stop frontimg; fi
    docker run -it -d --rm -p 3000:3000 --name frontimg frontimg
    echo "Run react"
    
    # kafkaproducer
    docker build -t kafkaproducer ./kafka/KafkaProducer
    if (docker ps | grep "kafkaproducer"); then docker stop kafkaproducer; fi
    docker run -it -d --rm -p 8090:8090 --name kafkaproducer kafkaproducer
    echo "Run kafkaproducer"
    ```
    

### 7. **Nginx ê²½ë¡œ ì„¤ì •**

- **Nginxë¥¼ í†µí•´ Reactì™€ Spring Boot ê²½ë¡œ ì„¤ì •**

### Reference

[CICD_manual/ë§¤ë‰´ì–¼ v2 at main Â· hjs101/CICD_manual](https://github.com/hjs101/CICD_manual/tree/main/%EB%A7%A4%EB%89%B4%EC%96%BC%20v2)

<br></br>

## â™»ï¸ Nginx

- Ubuntuì—ì„œ Nginxì˜ ê¸°ë³¸ì ì¸ ì„¤ì¹˜ì™€ ì„¤ì •

### 1. **Nginx ì„¤ì¹˜**

```bash
$ sudo apt-get install nginx
```

### 2. ì„¤ì¹˜ í›„ Nginx ì‹¤í–‰

```bash
$ service nginx start
# or
$ sudo service nginx start
# or
$ sudo systemctl start nginx
```

### 3. **Nginx ì„¤ì •**

- ì»¤ìŠ¤í…€ ì„¤ì • íŒŒì¼ â†’ sites-available ë””ë ‰í† ë¦¬ í•˜ìœ„ì— test.conf íŒŒì¼ì„ ìƒì„±,  ìˆ˜ì •

```bash
$ vi /etc/nginx/sites-available/test.conf

# test.conf ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì •
server {
  listen 80; #80í¬íŠ¸ë¡œ ë°›ì„ ë•Œ
  server_name j8c206.p.ssafy.io; # ì—†ì„ê²½ìš° localhost
  return 301 https://j8c206.p.ssafy.io$request_uri;

}
server {
  listen 443 ssl http2;
  server_name j8c206.p.ssafy.io;

  # ssl ì¸ì¦ì„œ ì ìš©
  ssl_certificate /etc/letsencrypt/live/j8c206.p.ssafy.io/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/j8c206.p.ssafy.io/privkey.pem;

  location / {
    proxy_pass http://localhost:3000;
  }

  location /api/v1 { # location ì´í›„ íŠ¹ì • urlì„ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì„ ì •ì˜
    proxy_pass http://localhost:8080; # Requestì— ëŒ€í•´ ì–´ë””ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ëŠ”ì§€
    proxy_redirect off;
    charset utf-8;

    proxy_http_version 1.1;
    proxy_set_header Connection "upgrade";
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-NginX-Proxy true;
  }
}
```

- ìƒì„±í•œ test.confë¥¼ sites-enabled ë””ë ‰í† ë¦¬ì— ì‹¬ë³¼ë¦­ ë§í¬ ì„¤ì •

```bash
$ ln -s /etc/nginx/sites-available/test.conf /etc/nginx/sites-enabled/test.conf
```

- ë³€ê²½ ì‚¬í•­ì„ ì ìš©

```bash
$ service nginx restart
# or
$ sudo service nginx restart
# or
$ *sudo systemctl restart nginx*
```

### Reference

[[Ubuntu] Nginx ì„¤ì •](https://computer-science-student.tistory.com/737)

[Nginxì™€ Let's Encryptë¡œ HTTPS ì›¹ ì„œë¹„ìŠ¤ ë°°í¬í•˜ê¸° (feat. Certbot)](https://hudi.blog/https-with-nginx-and-lets-encrypt/)

> â—sites-available/sites-enabled ëŠ” ë”ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” Nginx ì„¤ì • ë°©ë²•.
> 

> ì°¨í›„ Nginx ì„¤ì • ìˆ˜ì • ì˜ˆì •.
> 

<br></br>

## ğŸ” SSL

- ì›¹ì„œë¹„ìŠ¤ í•˜ë©´ ë¹¼ë†“ì„ ìˆ˜ ì—†ëŠ” https ì ìš©.
- certbotì„ ì‚¬ìš©í•´ letsencryptì—ì„œ ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ì•„ httpsë¥¼ ì ìš©í•œë‹¤.

### 1. Certbot ì„¤ì¹˜

```bash
# ì„œë²„ì— certbot ì¶”ê°€í•˜ê¸°
$ sudo apt-get-repository ppa:certbot/certbot
$ sudo apt-get update
$ sudo apt-get install python3-certbot-nginx
```

### 2. SSL ì¸ì¦ íšë“í•˜ê¸°

- ë‹¤ìŒ ì½”ë“œ ì…ë ¥

```bash
$ sudo certbot --nginx -d j8c206.p.ssafy.io
```

```
Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.
-------------------------------------------------------------------------------
1: No redirect - Make no further changes to the webserver configuration.
2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for
new sites, or if you're confident your site works on HTTPS. You can undo this
change by editing your web server's configuration.
-------------------------------------------------------------------------------
Select the appropriate number [1-2] then [enter] (press 'c' to cancel):
```

- ìœ„ ë©”ì‹œì§€ê°€ ë‚˜ì˜¤ë©´ 2ë¥¼ ëˆŒëŸ¬ì„œ ì§„í–‰
- nginx ì¬ì‹œì‘

```bash
$ service nginx restart
```

### 3. SSL ì ìš© í™•ì¸ ë° í‰ê°€

![SSLí™•ì¸](/images/SSLí™•ì¸.png)

### Reference

[[Nginx] Let's Encryptë¥¼ í†µí•´ Nginxì—ì„œ ë¬´ë£Œë¡œ https ì„¤ì •í•˜ê¸° - JP-HOSTING](https://jp-hosting.jp/nginx-lets-encryptë¥¼-í†µí•´-nginxì—ì„œ-ë¬´ë£Œë¡œ-https-ì„¤ì •í•˜ê¸°/)

[[NginX, Spring, React, MySQL] Docker ì´ìš©í•œ ì„œë²„ ë°°í¬(1) - NginX ì„¤ì¹˜, HTTPS ì„¤ì •(certbot)](https://velog.io/@hyeddo/NginX-Spring-React-MySQL-Docker-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%84%9C%EB%B2%84-%EB%B0%B0%ED%8F%AC1-NginX-%EC%84%A4%EC%B9%98-HTTPS-%EC%84%A4%EC%A0%95certbot)

<br></br>

## MYSQL(DB)

# EC2ì— Docker MySQL ì—°ê²°

---

## 1. Dockerì— MySQL ì´ë¯¸ì§€ ë‹¤ìš´

`$ docker pull mysql:latest`

## 2. Docker ì»¨í…Œì´ë„ˆ ë³¼ë¥¨ ìƒì„±

ì»¨í…Œì´ë„ˆì˜ ë‚´ë¶€ ë³¼ë¥¨ê³¼ í˜¸ìŠ¤íŠ¸ì˜ ë³¼ë¥¨ì„ ë§ˆìš´íŒ… í•´ì£¼ì–´ ì˜êµ¬ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³´ì¡´

```bash
$ docker volume create mysql-volume
# ë³¼ë¥¨ í™•ì¸
$ docker volume ls
```

## 3. ì»¨í…Œì´ë„ˆ ì‹¤í–‰

```bash
# 3307 í¬íŠ¸, ë³¼ë¥¨ ë§ˆìš´íŒ…, mysql ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
$ docker run -d --name mysql-container -p 3307:3306 -v mysql-volume:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=ë¹„ë°€ë²ˆí˜¸ mysql:latest
```

## 4. ì»¨í…Œì´ë„ˆ ì ‘ì†

`$ docker exec -it mysql-container bash`

## 5. MySQL ì„œë²„ ì ‘ì†

```bash
bash# mysql -u root -p
# ì»¨í…Œì´ë„ˆ ìƒì„± ì‹œ ì…ë ¥í–ˆë˜ íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥
Enter password:
...
mysql>
```

## 6. MySQL USER ìƒì„± í›„ ê¶Œí•œ ë¶€ì—¬

```bash
# USER ìƒì„±(test), '%'ëŠ” ëª¨ë“  IPì—ì„œ ì ‘ì† ê°€ëŠ¥
mysql> CREATE USER test@'%' identified by 'ë¹„ë°€ë²ˆí˜¸';
# ìƒì„±í•œ USERì— ëª¨ë“  ê¶Œí•œ ë¶€ì—¬
mysql> GRANT ALL PRIVILEGES ON *.* to test@'%';
# ë³€ê²½ ì‚¬í•­ ì ìš©
mysql> FLUSH PRIVILEGES;
mysql> exit;

```

## **ë°ì´í„°ë² ì´ìŠ¤ ì ‘ì† ì •ë³´**

- hostname: j8c206.p.ssafy.io
- port: 3306
- username: root
- password: ssafy